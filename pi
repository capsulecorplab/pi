#!/bin/bash
#
# pi - Pharo Install - A MIT-pip-like library for Pharo Smalltalk 
#
# Listing supports SmalltalkHub and GitHub. 
# 	SmalltalkHub listing requires libxml2 (xmllint command)
#	GitHub listing requires jq command (it will be downloaded if not present)
# Installs currently supported for:
# 	Metacello Configurations from Catalog (command line handler: get) 
# 	SmalltalkHub (command line handler: config)
#
# It works with curl or wget
# Tested on Windows 8.1 and GNU/Linux

#################################
## Pharo Installer Settings
#################################
PHARO_VERSION=61
piVersion=0.3.2
imageName="Pharo.image"
stHubUrl="http://smalltalkhub.com/"
stHubPkgIndexFile="index.html"
# Work in verbose (1) or silent mode (0)
silentMode=0
# Default Configuration/Baseline version (stable, development, bleedingEdge)
pkgVersion="stable"
# Detected Operating System
os="Unknown"

#################################
## Helper Functions
#################################

# Echo parameter text without carriage return/new line
function echo_line () {
	[ "$silentMode" == 0 ] && echo -n $1
}

# Echo parameter text with carriage return/new line
function echo_nline () {
	[ "$silentMode" == 0 ] && echo $1
}

# Returns 0 if command was found in the current system, 1 otherwise
function cmdExists () {
    type "$1" &> /dev/null || [ -f ./$1 ];
	return $?
}

function trim_both () {
	echo $(echo -e "${1}" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
}

function setDownloadApp () {
	echo_line "Checking for wget or curl..."
	if cmdExists wget ; then
		echo_nline "wget found..."
		dApp="wget --no-check-certificate"
		dListParams="-O ${stHubPkgIndexFile}"
		dPharoParams="-O-"
	elif cmdExists curl ; then
			echo_nline "curl found..."
			dApp="curl"
			dListParams="-o "$stHubPkgIndexFile
			dPharoParams=""
		else
			echo_nline "I require wget or curl, but it's not installed. (brew install wget?) Aborting."
			exit 1
	fi
}

function findDistributionID () {
	# Find our distribution or OS
	echo_line "Current OS is: "
	if [ -f /etc/os-release ]; then
		# freedesktop.org and systemd
		. /etc/os-release
		os=$NAME
		ver=$VERSION_ID
	elif type lsb_release >/dev/null 2>&1; then
		# linuxbase.org
		os=$(lsb_release -si)
		ver=$(lsb_release -sr)
	elif [ -f /etc/lsb-release ]; then
		# For some versions of Debian/Ubuntu without lsb_release command
		. /etc/lsb-release
		os=$DISTRIB_ID
		ver=$DISTRIB_RELEASE
	elif [ -f /etc/debian_version ]; then
		# Older Debian/Ubuntu/etc.
		os="Debian"
		ver=$(cat /etc/debian_version)
	elif [ -f /etc/SuSe-release ]; then
		# Older SuSE/etc.
		os="SuSE"
	elif [ -f /etc/redhat-release ]; then
		# Older Red Hat, CentOS, etc.
		os="RedHat"
	else
		# Fall back to uname, e.g. "Linux <version>", also works for BSD, etc.
		os=$(uname -s)
		ver=$(uname -r)
	fi	
	echo_nline "Found $os"
}

#################################################
# libXML / xmllint functions 
#################################################

function checkLibXML () {
	echo_nline "Checking for xmllint..."
	if ! cmdExists xmllint; then
		echo_nline "not found (install libxml2 or msys-libxml2 as required)"
		echo_line "Example: apt-get install libxml2-utils"
		exit 1
	else
		echo_nline "found"
	fi
}

function downloadLibXML () {
	local libXMLWinName="libxml2-2.7.8.win32"
	local libXMLWin32=$libXMLWinName".zip"
	local libXMLWin32URL="ftp://ftp.zlatkovic.com/libxml"
	local libXMLWin64="libxml2-2.9.3-win32-x86.7z"
	local libXMLWin64URL="ftp://ftp.zlatkovic.com/libxml/64bit/"
	
	local libXMLSolarisURL="http://get.opencsw.org/now"
	
	local libXMLMac1="combo-2007-10-07.dmg.gz"
	local libXMLMac2="combo-20031108.dmg.gz"
	local libXMLMacURL="https://www.explain.com.au/download/"
	
	setDownloadApp
	if ! cmdExists xmllint; then
		echo_nline "Trying to install libxml2..."
		case "$OSTYPE" in
			solaris*) 
				pkgadd -d $libXMLSolarisURL
				/opt/csw/bin/pkgutil -U
				/opt/csw/bin/pkgutil -y -i libxml2_2 
				/usr/sbin/pkgchk -L CSWlibxml2-2 # list files
				;;
			darwin*)  
				# Using Leopard? xmllint and libxml2 version 2.6.16 are built-in! xsltproc and libxslt version 1.1.12 are also included.
				# Using Tiger? xmllint and libxml2 version 2.6.16 are built-in! xsltproc and libxslt version 1.1.11 are also included.
				# Using Panther? xmllint and libxml2 version 2.5.4 are built-in! Even better, 10.3.9 has libxml2-2.6.16 and libxslt-1.1.9 built-in!
				$dApp $libXMLMacURL/$libXMLMac1
				$dApp $libXMLMacURL/$libXMLMac2
				# From https://www.explain.com.au/oss/libxml2xslt.html
				sudo mkdir -p /usr/local/bin
				cd /usr/local/bin
				sudo ln -s /Library/Frameworks/libxml.framework/Resources/Scripts/*
				sudo ln -s /Library/Frameworks/libxslt.framework/Resources/Scripts/*

				sudo mkdir -p /usr/local/include
				cd /usr/local/include
				sudo ln -s /Library/Frameworks/libxml.framework/Headers/*
				sudo ln -s /Library/Frameworks/libxslt.framework/Headers/*
				sudo ln -s /Library/Frameworks/libexslt.framework/Headers/*

				mkdir -p /usr/local/lib
				cd /usr/local/lib
				sudo ln -s /Library/Frameworks/libxml.framework/libxml libxml2.dylib
				sudo ln -s /Library/Frameworks/libxslt.framework/libxslt libxslt.dylib
				sudo ln -s /Library/Frameworks/libexslt.framework/libxslt libexslt.dylib

				sudo mkdir -p /usr/local/man/man1
				sudo mkdir -p /usr/local/man/man3
				echo 'export PATH=/usr/local/bin:$PATH' >> ~/.bashrc
				echo 'export MANPATH=/usr/local/man:$MANPATH' >> ~/.bashrc
				source ~/.bashrc				
				;; 
			linux*)   
				echo "Should be implemented"
				;;
			bsd*)     
				echo_line "BSD seems not supported by libxml2. See http://www.xmlsoft.org for details" 
				;;
			msys*)
				# Remove any previous download of ZIP file
				
				$dApp $libXMLWin32URL/$libXMLWin32
				unzip -u $libXMLWin32
				# Copy to current directory
				cp -v $libXMLWinName/bin/* .
				;;
			*) 
				echo "unknown: $OSTYPE" 
				;;
		esac
		echo_nline "done"
	fi
}

# Search argument XPATH expression in HTML file
function xpath() {
	if [ $# -ne 2 ]; then
		echo "Usage: xpath xpath file"
		return 1
	fi
	downloadLibXML
	# GitBash doesn't provide /usr/local/bin and cannot copy xmllint.exe to any PATH directory without permission denied
	if ! cmdExists xmllint; then
		./xmllint --nonet --html --shell $2 <<< "cat $1" | sed '/^\/ >/d;/^\ /d'
	else
		xmllint --nonet --html --shell $2 <<< "cat $1" | sed '/^\/ >/d;/^\ /d'
	fi
}

#########################################
# PI Options
#########################################

function versionString () {
	silentMode=0
	echo_nline "pi - Pharo Install [version $piVersion]"
}

function printHelp () {
	silentMode=0
cat << EOF
pi - Pharo Install [version $piVersion]

PI is a tool for installing Pharo Smalltalk packages.

The options include:
		listgh			List packages found in GitHub
		listsh			List packages found in SmalltalkHub
		countsh			Report how many packages were found in SmalltalkHub
		countgh			Report how many packages were found in GitHub
		search <pgname>		Search for pkgname in SmalltalkHub and GitHub repositories
		searchgh <pkgname>	Search for pkgname in GitHub repository
		searchsh <pkgname>	Search for pkgname in SmalltalkHub repository
		image			Fetch the latest stable Pharo (VM + Image).
		examples		Show usage examples
		version 		Show program version
		install <pkgname>	Install pkgname to the image found in the current working directory. Download the image if not found.

		--dev			Set Configuration/Baseline to install development versions.
		--bleedingEdge		Set Configuration/Baseline to install bleedingEdge version.
		
Pharo Install project home page: https://github.com/hernanmd/pi
To report bugs or get some help check: https://github.com/hernanmd/pi/issues
This software is licensed under the MIT License.
EOF
}

function examples () {
	echo "
List GitHub packages:
$0 listgh

List SmalltalkHub packages:
$0 listsh

Search Both SmalltalkHub and GitHub packages:
$0 search pillar

Download latest stable Pharo image and VM:
$0 image

Install multiple packages:
$0 install Diacritics ISO3166 StringExtensions"
}

#################################
## Pharo Installation Functions
#################################

# Currently not used

# For Debian, Slackware and Ubuntu
function apt_install () {
	sudo dpkg --add-architecture i386
	sudo apt-get update
	sudo apt-get install libc6:i386 libssl1.0.0:i386 libfreetype6:i386
}

# For ElementaryOS
function ppa_install () {
	add-apt-repository ppa:pharo/stable
	apt-get update
	apt-get install pharo-vm-desktop
}

# For CentOS/RedHat
function yum_install () {
	yum install ld-linux.so.2 \
		glibc-devel.i686 \
		glibc-static.i686 \
		glibc-utils.i686 \
		libX11.i686 \
		libX11-devel.i686 \
		mesa-libGL.i686 \
		mesa-libGL-devel.i686 \
		libICE.i686 \
		libICE-devel.i686 \
		libSM.i686
}

# Prefer provider packages if distribution was found
function install_pharo () {
	silentMode=1
	findDistributionID
	case $os in
		"elementary" )
			ppa_install
			;;	
		"CentOS*" | "RedHat*" )
			yum_install
			;;
		"Ubuntu*")
			ppa_install
			;;
		* )
			echo "Installing Pharo from get.pharo.org"
			dlPharo
			;;
	esac
}

#################################
## Packages Installation Functions
#################################

function dlStHubPkgNames () {
	setDownloadApp
	local listUrl=$stHubUrl"list"
	$dApp $dListParams $listUrl
}

function fetchGitHubPkgNames () {
	setDownloadApp
	local ghPharoTopics="https://api.github.com/search/repositories?per_page=100&q=topic:pharo"
	# local GH_HEADER="Accept: application/vnd.github.mercy-preview+json"
	local ghPharoIndexFile="pharo.js"
	# Download JSON file if not present
	if [ ! -f $ghPharoIndexFile ]; then
		$dApp $ghPharoTopics -O $ghPharoIndexFile
	fi
	if ! cmdExists jq; then
		# wget http://stedolan.github.io/jq/download/linux32/jq (32-bit system)
		echo_nline "Trying to download jq..."
		case "$OSTYPE" in
			solaris*) 
				echo_line "Solaris seems not supported by jq. See https://stedolan.github.io/jq/ for details" 
				;;
			darwin*)  
				$dApp https://github.com/stedolan/jq/releases/download/jq-1.5/jq-osx-amd64
				chmod +x ./jq
				;; 
			linux*)   
				$dApp http://stedolan.github.io/jq/download/linux64/jq
				chmod +x ./jq
				;;
			bsd*)     
				echo_line "BSD seems not supported by jq. See https://stedolan.github.io/jq/ for details" 
				;;
			msys*)    
				$dApp -O jq.exe https://github.com/stedolan/jq/releases/download/jq-1.5/jq-win64.exe 
				;;
			*) 
				echo "unknown: $OSTYPE" 
				;;
		esac
	fi
	PKGS=$(./jq '.items[].full_name' $ghPharoIndexFile)	
}

function fetchStHubPkgNames () {
	echo_nline "Checking package list file..."
	if [ ! -f $stHubPkgIndexFile ]; then
		echo_nline "not found"
		echo_nline "Downloading packages list..."
		dlStHubPkgNames
	else
		echo_line "found $stHubPkgIndexFile"
	fi
	PKGS=$(xpath "//a[@class=\"project\"]/text()" $stHubPkgIndexFile)
}

# Report how many packages were found in SmalltalkHub
function countsh_packages () {
	silentMode=1
	fetchStHubPkgNames
	echo -ne "$PKGS" | wc -l
}

# Report how many packages were found in GitHub
function countgh_packages () {
	silentMode=1
	fetchGitHubPkgNames
	echo -ne "$PKGS" | wc -l
}

# Install from Catalog
function pkgCatalogInstall () {
	pkgName=$1
	./pharo $imageName get $pkgName 
	return $?
}

# Detect which Configuration version to install.
# This setting is global: Applied to all Configuration names passed as parameters.
function setPkgVersionSetting () {
	echo_nline "Setting package version..."
	for param in "$@"; do
		case $param in	
			"--dev")
				pkgVersion="development"
				;;
			"--bleedingEdge")
				pkgVersion="bleedingEdge"
				;;
		esac
	done
	echo_nline "Selected package version: $pkgVersion"
}

# Install from STHub
# Currently uses exact match for package names
function pkgSHInstall () {
	pkgName=$1
	fetchStHubPkgNames
	pkgFound=$(echo "$PKGS" | grep -w $pkgName)
	pkgCount=$(echo "$pkgFound" | wc -l)
	echo "Found $pkgCount package(s) with the name $pkgName."
	if [ "$pkgCount" -gt 1 ]; then
		echo "Listing follows..."
		cat -n <<< "$pkgFound"	
		return 1
	else
		echo "Selected package: $pkgFound"
		IFS=/ read p USER <<< "$pkgFound"
		repoUrl=$stHubUrl"mc/"$USER/$pkgName
		echo "Repository: $repoUrl"
	fi
	echo "Install command: ./pharo $imageName config $repoUrl "ConfigurationOf"$pkgName --install=$pkgVersion --printVersion"
	./pharo $imageName config $repoUrl "ConfigurationOf"$pkgName --install=$pkgVersion --printVersion
	return $?
}

# Read argument packages and install from their repositories
function install_packages () {
	until [ -z "$1" ]; do
		echo_nline "Trying to install from Pharo Catalog..."
		if ! (pkgCatalogInstall $1); then
			echo_nline "not found"
			echo_nline "Trying to install from SmalltalkHub..."
			if ! (pkgSHInstall $1); then
				echo_line "not found"
			else
				echo_line "done"
			fi
		else
			echo_line "done"
		fi
		shift
	done		
}

###################################
## Pharo Searching Packages Section
###################################

# Search for package passed as argument in the SmalltalkHub repository
function searchsh_packages () {
	silentMode=1
	checkLibXML		
	fetchStHubPkgNames
	printf -- '%s\n' "$PKGS[@]" | grep -i "$1" | sed 's/^/SmalltalkHub\: /'
}

# Search for package passed as argument in the GitHub repository
function searchgh_packages () {
	silentMode=1
	fetchGitHubPkgNames
	printf -- '%s\n' "$PKGS[@]" | grep -i "$1" | sed 's/^/GitHub\: /'
}

# Search for package passed as argument in all supported repositories
function search_packages () {
	silentMode=1
	searchsh_packages $1
	searchgh_packages $1
}

#################################
## Pharo Installation Section
#################################

function dlPharo () {
	silentMode=0
	echo_nline "Checking Pharo installation already present..."
	if [ ! -f $imageName ]; then
		echo_nline "not found"
		setDownloadApp	
		echo_nline "Downloading Pharo (stable version)..."
#		exec $dApp $dPharoParams get.pharo.org/$PHARO_VERSION+vm | bash
		exec $dApp $dPharoParams https://get.pharo.org | bash
	else
		echo_nline "found $imageName in the current directory"
	fi

	if [ ! -f pharo ]; then
		echo_nline "Try again. Pharo was not downloaded correctly, exiting"
		exit 1
	fi
}

#################################
## Main Section
#################################

case $1 in
	listgh | listGH | LISTGH )
		silentMode=0
		fetchGitHubPkgNames
		echo "$PKGS"
		;;
	listsh | listSH | LISTSH ) 
		silentMode=1
		checkLibXML		
		fetchStHubPkgNames
		echo "$PKGS"
		;;
	help | h ) 
		printHelp
		;;		
	countsh | COUNTSH )
		silentMode=1
		checkLibXML
		countsh_packages
		;;
	countgh | COUNTSH )
		countgh_packages
		;;		
	install | INSTALL )
		install_pharo
		install_packages "${@:2}"
		;;
	image | IMAGE )
		install_pharo
		;;
	searchsh )
		searchsh_packages "${@:2}"
		;;
	searchgh )
		searchgh_packages "${@:2}"
		;;
	search )
		search_packages "${@:2}"
		;;		
	version )
		versionString
		;;
	examples | EXAMPLES ) 
		examples && exit 0
		;;
	"--dev" | "--bleedingEdge")
		setPkgVersionSetting "${@}"
		#install_pharo
		#install_packages "${@:3}"		
		;;
	* ) 
	echo $"Usage: $0 {list | listGH | listSH | countGH | countSH | image | examples | [--dev|--bleedingEdge] install <pkgname>}"
	exit 1
esac

